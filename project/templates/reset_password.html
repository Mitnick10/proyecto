{% extends "base.html" %}

{% block title %}Restablecer Contraseña{% endblock %}

{% block content %}
<div class="relative min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="absolute inset-0 z-0"
        style="background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi7JWoDhdscUjLrQN6iqKerme1yy7-msHf1uB1NiILqNYlOkWZr5Cd8P2SfQI85bqMWO4CdanMOoB5WsvlGWVZLz2TsGzaGe8gdHM7g7LPxk93u9gJsxYZq81WddJXWv_M8gNMU8CUZLLg/s1600/65591412.wPaGxmkS.P7267968970'); background-size: cover; background-position: center; background-attachment: fixed;">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
    </div>

    <div class="relative z-10 w-full max-w-md bg-white rounded-lg shadow-xl p-8 space-y-6">

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-4">
            {% for category, message in messages %}
            <div
                class="p-4 rounded-md text-sm {{ 'bg-red-100 text-red-700' if category == 'error' else 'bg-green-100 text-green-700' }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <div class="flex flex-col items-center">
            <img class="h-20 w-auto" src="{{ url_for('static', filename='logo.png') }}" alt="IRDEBG GUÁRICO">
            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                Restablecer Contraseña
            </h2>
            <p class="mt-2 text-center text-sm text-gray-600">
                Ingresa tu nueva contraseña.
            </p>
        </div>

        <form class="space-y-6" action="{{ url_for('auth.reset_password') }}" method="POST" id="resetForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}" />
            <input type="hidden" name="access_token" id="access_token">
            <input type="hidden" name="refresh_token" id="refresh_token">

            <div>
                <label for="password" class="sr-only">Nueva Contraseña</label>
                <input id="password" name="password" type="password" required
                    class="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    placeholder="Nueva contraseña">
            </div>

            <div>
                <label for="confirm_password" class="sr-only">Confirmar Contraseña</label>
                <input id="confirm_password" name="confirm_password" type="password" required
                    class="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    placeholder="Confirmar contraseña">
            </div>

            <div>
                <button type="submit"
                    class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition shadow-lg hover:shadow-xl">
                    <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                        <i class="fa-solid fa-key"></i>
                    </span>
                    Cambiar Contraseña
                </button>
            </div>

            <div class="text-center">
                <a href="{{ url_for('auth.login') }}" class="font-medium text-blue-600 hover:text-blue-500">
                    Volver al inicio de sesión
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    // Script para extraer el token del fragmento de la URL (#)
    document.addEventListener('DOMContentLoaded', function () {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const accessToken = params.get('access_token');
        const refreshToken = params.get('refresh_token');
        const type = params.get('type');
        const errorDescription = params.get('error_description');

        if (accessToken) {
            document.getElementById('access_token').value = accessToken;
        }
        if (refreshToken) {
            document.getElementById('refresh_token').value = refreshToken;
        }

        if (errorDescription) {
            alert('Error: ' + decodeURIComponent(errorDescription));
        }

        // Si no hay token en el hash, verificar si ya estamos logueados o mostrar error
        if (!accessToken && type !== 'recovery' && !errorDescription) {
            console.log("No access token found in URL fragment");
        }
    });
</script>
{% endblock %}