{% extends "layout.html" %}

{% block title %}Ficha Técnica - {{ beca.nombre }} {{ beca.apellido }}{% endblock %}
{% block header %}Ficha del Atleta{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">

    <!-- Botones de Acción (Solo Volver y Editar) -->
    <div class="flex justify-end gap-3 mb-6">
        <a href="{{ url_for('dashboard.lista_becas') }}"
            class="px-4 py-2 border border-slate-300 rounded-md bg-white text-sm font-medium text-slate-700 hover:bg-slate-50">
            &larr; Volver
        </a>
        {% if user_role in ['admin', 'superadmin'] %}
        <a href="{{ url_for('dashboard.editar_beca', beca_id=beca.id) }}"
            class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">
            <i class="fa-solid fa-pen-to-square mr-2"></i> Editar Datos
        </a>
        {% endif %}
    </div>

    <!-- HOJA DE FICHA TÉCNICA -->
    <div
        class="bg-white shadow-xl p-8 md:p-12 border border-slate-200 relative text-xs md:text-sm font-sans text-slate-800">

        <!-- ENCABEZADO -->
        <div class="text-center mb-6 border-b-2 border-slate-800 pb-4">
            <div class="flex justify-between items-center mb-2">
                <div class="w-20 opacity-80">

                </div>
                <div class="flex-1 px-4">
                    <h1 class="font-bold text-lg uppercase tracking-wide">República Bolivariana de Venezuela</h1>
                    <h2 class="font-bold text-base uppercase text-red-600">Instituto Regional de Deportes del Estado
                        Bolivariano de Guárico</h2>
                    <h3 class="font-semibold text-slate-600 uppercase tracking-widest mt-1">Programa de Becas Deportivas
                    </h3>
                </div>
                <div class="w-20 text-center">
                    <span class="text-xl font-black text-red-600 tracking-tighter block">IRDEBG</span>
                </div>
            </div>
            <div class="bg-slate-100 py-1 mt-2 border border-slate-300">
                <h1 class="text-xl font-black uppercase tracking-[0.2em]">FICHA ATLETA</h1>
            </div>
        </div>

        <!-- SECCIÓN 1: IDENTIFICACIÓN -->
        <div class="grid grid-cols-12 gap-0 border border-slate-400 mb-6">
            <div class="col-span-8 border-r border-slate-400 p-2">
                <div class="flex items-baseline mb-2">
                    <span class="font-bold w-40">DISCIPLINA DEPORTIVA:</span>
                    <span class="border-b border-slate-400 flex-1 uppercase pl-2 font-semibold">{{ beca.disciplina
                        }}</span>
                </div>
                <div class="flex items-baseline">
                    <span class="font-bold w-40">ESPECIALIDAD:</span>
                    <span class="border-b border-slate-400 flex-1 uppercase pl-2 italic font-semibol">{{
                        beca.especialidad or '--' }}</span>
                </div>
            </div>
            <div class="col-span-4 p-2 bg-slate-50">
                <div class="flex flex-col h-full justify-center text-center">
                    <span class="font-bold text-[10px] text-slate-500 uppercase">Fecha Registro</span>
                    <span class="font-mono text-lg">{{ beca.created_at[:10] if beca.created_at else '--' }}</span>
                </div>
            </div>
        </div>

        <!-- REPRESENTANTE -->
        {% if beca.es_menor %}
        <div class="mb-6">
            <h3 class="bg-blue-800 text-white font-bold px-2 py-1 text-xs uppercase mb-0">Datos del Representante Legal
            </h3>
            <div class="grid grid-cols-12 gap-0 border border-slate-400">
                <div class="col-span-6 border-r border-slate-400 p-2">
                    <span class="block font-bold text-[10px] text-slate-500">NOMBRE</span>
                    <span class="block font-semibold uppercase">{{ beca.representante_nombre or '--' }}</span>
                </div>
                <div class="col-span-3 border-r border-slate-400 p-2">
                    <span class="block font-bold text-[10px] text-slate-500">CÉDULA</span>
                    <span class="block font-mono">{{ beca.representante_cedula or '--' }}</span>
                </div>
                <div class="col-span-3 p-2">
                    <span class="block font-bold text-[10px] text-slate-500">PARENTESCO</span>
                    <span class="block font-semibold uppercase">{{ beca.representante_parentesco or '--' }}</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- DATOS PERSONALES -->
        <div class="mb-6">
            <h3 class="bg-slate-800 text-white font-bold px-2 py-1 text-xs uppercase mb-0">Datos Personales</h3>
            <div class="grid grid-cols-12 gap-0 border-l border-b border-slate-400">
                <div class="col-span-2 border-t border-r border-slate-400 p-2 bg-slate-50"><span
                        class="block font-bold text-[10px] mb-1">NACIONALIDAD</span><span
                        class="block font-semibold uppercase">VENEZOLANA</span></div>
                <div class="col-span-2 border-t border-r border-slate-400 p-2 bg-slate-50"><span
                        class="block font-bold text-[10px] mb-1">CÉDULA</span><span
                        class="block font-mono font-bold text-base">{{ beca.cedula }}</span></div>
                <div class="col-span-3 border-t border-r border-slate-400 p-2"><span
                        class="block font-bold text-[10px] text-slate-500 mb-1">APELLIDOS</span><span
                        class="block font-semibold uppercase text-sm">{{ beca.apellido }}</span></div>
                <div class="col-span-3 border-t border-r border-slate-400 p-2"><span
                        class="block font-bold text-[10px] text-slate-500 mb-1">NOMBRES</span><span
                        class="block font-semibold uppercase text-sm">{{ beca.nombre }}</span></div>

                <!-- FOTO -->
                <div class="col-span-2 row-span-3 border-t border-r border-slate-400 p-1 relative">
                    <div
                        class="w-full h-full min-h-[140px] bg-slate-100 flex items-center justify-center border border-slate-200">
                        {% if beca.foto %}
                        <img src="{{ beca.foto }}" class="w-full h-full object-cover max-h-[150px]">
                        {% else %}
                        <span class="text-slate-300 font-bold text-xs text-center">FOTO<br>TIPO CARNET</span>
                        {% endif %}
                    </div>
                </div>

                <div class="col-span-3 border-t border-r border-slate-400 p-2"><span
                        class="block font-bold text-[10px] mb-1">F. NACIMIENTO / EDAD</span>
                    <div class="flex gap-2"><span
                            class="border-b border-slate-300 flex-1 text-center font-mono text-xs pt-1">{{
                            beca.fecha_nacimiento or '--' }}</span><span class="font-bold">({{ beca.edad or '-' }}
                            Años)</span></div>
                </div>
                <div class="col-span-2 border-t border-r border-slate-400 p-2 text-center"><span
                        class="block font-bold text-[10px] mb-1">SEXO</span><span
                        class="block font-semibold uppercase">{{ beca.sexo or '-' }}</span></div>
                <div class="col-span-2 border-t border-r border-slate-400 p-2 text-center"><span
                        class="block font-bold text-[10px] mb-1">G. SANGUÍNEO</span><span
                        class="block text-slate-600 font-bold uppercase">{{ beca.sangre or '--' }}</span></div>
                <div class="col-span-1 border-t border-r border-slate-400 p-2 text-center"><span
                        class="block font-bold text-[10px] mb-1">PESO</span><span
                        class="block text-slate-600 font-bold">{{ beca.peso or '--' }}</span></div>
                <div class="col-span-2 border-t border-r border-slate-400 p-2 text-center"><span
                        class="block font-bold text-[10px] mb-1">ESTATURA</span><span
                        class="block text-slate-600 font-bold">{{ beca.estatura or '--' }}</span></div>

                <div class="col-span-2 border-t border-r border-slate-400 p-2 bg-slate-50"><span
                        class="block font-bold text-[10px] mb-1">PAÍS</span><span
                        class="uppercase text-xs">VENEZUELA</span></div>
                <div class="col-span-2 border-t border-r border-slate-400 p-2 bg-slate-50"><span
                        class="block font-bold text-[10px] mb-1">ESTADO</span><span
                        class="uppercase text-xs">GUÁRICO</span></div>
                <div class="col-span-3 border-t border-r border-slate-400 p-2"><span
                        class="block font-bold text-[10px] mb-1">MUNICIPIO</span><span
                        class="uppercase text-xs font-semibold">{{ beca.municipio or '-' }}</span></div>
                <div class="col-span-3 border-t border-r border-slate-400 p-2"><span
                        class="block font-bold text-[10px] mb-1">DIRECCIÓN / CONTACTO</span><span
                        class="uppercase text-xs truncate block" title="{{ beca.direccion or '' }}">{{ beca.direccion or
                        '--' }}</span><span class="text-[10px] text-slate-500 block mt-1">{{ beca.telefono or ''
                        }}</span></div>
            </div>
        </div>

        <!-- PROGRAMA Y BANCO -->
        <div class="grid grid-cols-2 gap-6 mb-6">
            <div class="border border-slate-400 p-3">
                <span class="block font-bold text-xs uppercase text-slate-500 mb-1">Programa</span>
                <span class="block font-bold text-lg uppercase text-blue-900">{{ beca.tipo_beca }}</span>
                <span class="block text-xs uppercase text-slate-500 mt-1">Categoría: {{ beca.categoria or '--' }}</span>
            </div>
            <div class="border border-slate-400 p-3 relative">
                <span class="block font-bold text-xs uppercase text-slate-500 mb-1">
                    {% if beca.es_menor %}N° Cuenta (Representante){% else %}N° Cuenta (Atleta){% endif %}
                </span>
                <span class="block font-mono text-lg tracking-wider">{{ beca.cuenta_bancaria or 'NO REGISTRADA'
                    }}</span>
            </div>
        </div>

        <!-- INFO MÉDICA -->
        <div class="mb-6">
            <h3 class="bg-slate-800 text-white font-bold px-2 py-1 text-xs uppercase mb-0">Información Médica</h3>
            <div class="border border-slate-400 grid grid-cols-7 text-center divide-x divide-slate-400 text-[10px]">
                <div class="p-2"><span class="block font-bold mb-1">LENTES</span><span class="font-bold uppercase">{{
                        beca.usa_lentes or 'NO' }}</span></div>
                <div class="p-2"><span class="block font-bold mb-1">BUCAL</span><span class="font-bold uppercase">{{
                        beca.usa_bucal or 'NO' }}</span></div>
                <div class="p-2"><span class="block font-bold mb-1">MUÑEQUERA</span><span class="font-bold uppercase">{{
                        beca.usa_munequera or 'NO' }}</span></div>
                <div class="p-2"><span class="block font-bold mb-1">RODILLERA</span><span class="font-bold uppercase">{{
                        beca.usa_rodilleras or 'NO' }}</span></div>
                <div class="p-2"><span class="block font-bold mb-1">DIETA</span><span class="font-bold uppercase">{{
                        beca.dieta_deportiva or 'NO' }}</span></div>
                <div class="p-2"><span class="block font-bold mb-1">MÉDICO</span><span class="font-bold uppercase">{{
                        beca.control_medico or 'NO' }}</span></div>
                <div class="p-2"><span class="block font-bold mb-1">SOCIAL</span><span class="font-bold uppercase">{{
                        beca.estudio_social or 'NO' }}</span></div>
            </div>
        </div>

        <!-- TALLAS -->
        <div class="mb-6">
            <h3 class="bg-slate-800 text-white font-bold px-2 py-1 text-xs uppercase mb-0">Tallas</h3>
            <table class="w-full border border-slate-400 text-center text-xs uppercase">
                <tr class="bg-slate-100 border-b border-slate-400 font-bold">
                    <td class="p-2 border-r border-slate-400">Calzado</td>
                    <td class="p-2 border-r border-slate-400">Franela</td>
                    <td class="p-2 border-r border-slate-400">Short</td>
                    <td class="p-2 border-r border-slate-400">Chemise</td>
                    <td class="p-2 border-r border-slate-400">Mono</td>
                    <td class="p-2">Competencia</td>
                </tr>
                <tr>
                    <td class="p-3 border-r border-slate-400 font-bold">{{ beca.talla_zapato or '--' }}</td>
                    <td class="p-3 border-r border-slate-400 font-bold">{{ beca.talla_franela or '--' }}</td>
                    <td class="p-3 border-r border-slate-400 font-bold">{{ beca.talla_short or '--' }}</td>
                    <td class="p-3 border-r border-slate-400 font-bold">{{ beca.talla_chemise or '--' }}</td>
                    <td class="p-3 border-r border-slate-400 font-bold">{{ beca.talla_mono or '--' }}</td>
                    <td class="p-3 font-bold">{{ beca.talla_competencia or '--' }}</td>
                </tr>
            </table>
        </div>

        <!-- MEDALLAS -->
        <div class="mb-8">
            <h3 class="bg-slate-800 text-white font-bold px-2 py-1 text-xs uppercase mb-0">Palmarés Deportivo</h3>
            <div class="border border-slate-400 min-h-[60px]">
                {% if medallas %}
                <table class="w-full text-left text-xs">
                    <tbody class="divide-y divide-slate-200">
                        {% for m in medallas %}
                        <tr>
                            <td class="p-2 pl-4 font-bold uppercase w-32">{{ m.tipo_medalla }}</td>
                            <td class="p-2 uppercase">{{ m.competicion }}</td>
                            <td class="p-2 font-mono text-right pr-4">{{ m.fecha or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="p-2 text-slate-400 text-xs italic text-center">Sin medallas registradas.</p>
                {% endif %}
            </div>
        </div>

        <!-- DOCUMENTOS DIGITALES -->
        <div class="mb-8">
            <h3
                class="bg-blue-800 text-white font-bold px-2 py-1 text-xs uppercase mb-0 flex justify-between items-center">
                Documentos Digitales
                {% if user_role in ['admin', 'superadmin'] %}
                <span class="text-[10px] font-normal opacity-80">Subir archivos en "Editar Datos"</span>
                {% endif %}
            </h3>

            <div class="border border-slate-400 p-4 bg-slate-50">
                <!-- Formulario Subir (Solo Admin) -->
                {% if user_role in ['admin', 'superadmin'] %}
                <form action="{{ url_for('dashboard.subir_documento', beca_id=beca.id) }}" method="POST"
                    enctype="multipart/form-data" class="flex gap-2 mb-4 border-b border-slate-200 pb-4">
                    <select name="nombre_doc" class="text-xs rounded border-slate-300">
                        <option>Cédula</option>
                        <option>Partida Nacimiento</option>
                        <option>Cédula Repre.</option>
                        <option>Constancia</option>
                        <option>Otro</option>
                    </select>
                    <input type="file" name="archivo" accept=".pdf" required
                        class="text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <button type="submit"
                        class="bg-blue-600 text-white text-xs px-3 py-1 rounded hover:bg-blue-700">Subir
                        PDF</button>
                </form>
                {% endif %}

                <!-- Lista de Documentos -->
                {% if documentos %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    {% for doc in documentos %}
                    <div
                        class="flex justify-between items-center p-2 bg-white border border-slate-200 rounded shadow-sm">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <i class="fa-solid fa-file-pdf text-red-600"></i>
                            <span class="text-xs font-bold truncate uppercase">{{ doc.nombre }}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- BOTÓN PREVISUALIZAR -->
                            <button onclick="verPDF('{{ doc.archivo }}')"
                                class="text-blue-600 hover:text-blue-800 text-xs font-bold">
                                <i class="fa-solid fa-eye"></i> Ver
                            </button>

                            {% if user_role in ['admin', 'superadmin'] %}
                            <form action="{{ url_for('dashboard.eliminar_documento', doc_id=doc.id) }}" method="POST"
                                onsubmit="return confirm('¿Borrar documento?');">
                                <input type="hidden" name="atleta_id" value="{{ beca.id }}">
                                <button type="submit" class="text-slate-400 hover:text-red-600"><i
                                        class="fa-solid fa-trash"></i></button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-xs text-slate-400 italic text-center">No hay documentos digitales cargados.
                </p>
                {% endif %}
            </div>
        </div>

    </div>

    <!-- MODAL PREVISUALIZACIÓN PDF -->
    <div id="modalPDF"
        class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-5xl h-[85vh] rounded-lg shadow-2xl flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-3 bg-slate-800 text-white">
                <h3 class="font-bold text-sm">Previsualización de Documento</h3>
                <button onclick="cerrarPDF()"
                    class="text-slate-300 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <iframe id="iframePDF" src="" class="w-full h-full bg-slate-100"></iframe>
        </div>
    </div>

    <script>
        function verPDF(base64) {
            document.getElementById('iframePDF').src = base64;
            document.getElementById('modalPDF').classList.remove('hidden');
        }
        function cerrarPDF() {
            document.getElementById('modalPDF').classList.add('hidden');
            document.getElementById('iframePDF').src = "";
        }
    </script>
    {% endblock %}