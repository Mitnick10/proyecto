{% extends 'layout.html' %}

{% block title %}Ficha del Atleta{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Botones de Acción -->
    <div class="flex flex-wrap justify-end gap-2 md:gap-3 mb-6 no-print">


        {% if user_role in ['admin', 'superadmin'] %}
        <a href="{{ url_for('dashboard.editar_beca', beca_id=beca.id) }}"
            class="px-3 md:px-4 py-2 bg-blue-600 text-white rounded-md text-xs md:text-sm font-medium hover:bg-blue-700">
            <i class="fa-solid fa-pen-to-square mr-1 md:mr-2"></i> Editar Datos
        </a>
        {% endif %}

        <button onclick="imprimirFichaDocumentos()"
            class="px-3 md:px-4 py-2 bg-green-600 text-white rounded-md text-xs md:text-sm font-medium hover:bg-green-700">
            <i class="fa-solid fa-print mr-1 md:mr-2"></i> Imprimir
        </button>





    </div>

    <!-- FICHA TÉCNICA (Diseño Oficial) -->
    <div class="bg-white shadow-2xl overflow-hidden print:shadow-none print:w-full" id="ficha-tecnica">
        <!-- Encabezado Oficial -->
        <div class="p-8 pb-4 border-b-2 border-slate-800 flex justify-between items-start gap-4">
            <div class="flex-shrink-0">
                <img src="{{ url_for('static', filename='bandera_guarico.png') }}" alt="Bandera del Estado Guárico"
                    class="h-16 w-auto">
            </div>
            <div class="flex-1 text-center">
                <h1 class="font-bold text-lg md:text-xl uppercase tracking-wider mb-1">República Bolivariana de
                    Venezuela</h1>
                <h2 class="font-bold text-sm md:text-base uppercase mb-1">Instituto Regional de Deportes del Estado
                    Bolivariano de Guárico</h2>
                <h3 class="font-bold text-base md:text-lg uppercase text-blue-800">Programa de Becas Deportivas</h3>
            </div>
            <div class="flex-shrink-0">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo IRDEBG" class="h-16 w-auto">
            </div>
        </div>

        <div class="p-8">
            <div class="flex justify-between items-end mb-6 border-b border-slate-400 pb-2">
                <div>
                    <h2 class="text-2xl font-black uppercase text-slate-900">Ficha del Atleta</h2>
                    <p class="text-sm text-slate-600 uppercase font-bold">Disciplina: <span class="text-blue-800">{{
                            beca.disciplina }}</span></p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-bold text-slate-500 uppercase">Fecha de Registro</p>
                    <p class="font-mono text-lg">{{ beca.created_at[:10] if beca.created_at else '--' }}</p>
                </div>
            </div>

            <!-- Datos del Representante (Si es menor Y tiene datos) -->
            {% if beca.es_menor and beca.representante_nombre and beca.representante_nombre != '--' %}
            <div class="mb-6">
                <h3 class="bg-blue-800 text-white font-bold px-2 py-1 text-xs uppercase mb-0">Datos del Representante
                    Legal</h3>
                <div class="grid grid-cols-12 gap-0 border border-slate-400">
                    <div class="col-span-6 border-r border-slate-400 p-2">
                        <span class="block font-bold text-[10px] text-slate-500">NOMBRE</span>
                        <span class="block font-semibold uppercase">{{ beca.representante_nombre or '--' }}</span>
                    </div>
                    <div class="col-span-3 border-r border-slate-400 p-2">
                        <span class="block font-bold text-[10px] text-slate-500">CÉDULA</span>
                        <span class="block font-mono">{{ beca.representante_cedula or '--' }}</span>
                    </div>
                    <div class="col-span-3 p-2">
                        <span class="block font-bold text-[10px] text-slate-500">PARENTESCO</span>
                        <span class="block font-semibold uppercase">{{ beca.representante_parentesco or '--' }}</span>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Datos Personales y Foto -->
            <div class="mb-6">
                <h3 class="bg-slate-800 text-white font-bold px-2 py-1 text-xs uppercase mb-0">Datos Personales</h3>
                <div class="grid grid-cols-12 gap-0 border-l border-b border-slate-400">
                    <!-- Columna Izquierda (Datos) -->
                    <div class="col-span-10 grid grid-cols-12">
                        <div class="col-span-3 border-t border-r border-slate-400 p-2 bg-slate-50">
                            <span class="block font-bold text-[10px] mb-1">NACIONALIDAD</span>
                            <span class="block font-semibold uppercase">VENEZOLANA</span>
                        </div>
                        <div class="col-span-3 border-t border-r border-slate-400 p-2 bg-slate-50">
                            <span class="block font-bold text-[10px] mb-1">CÉDULA</span>
                            <span class="block font-mono font-bold text-base">{{ beca.cedula }}</span>
                        </div>
                        <div class="col-span-6 border-t border-r border-slate-400 p-2">
                            <span class="block font-bold text-[10px] text-slate-500 mb-1">NOMBRE COMPLETO</span>
                            <span class="block font-semibold uppercase text-sm">{{ beca.nombre }} {{ beca.apellido
                                }}</span>
                        </div>

                        <div class="col-span-3 border-t border-r border-slate-400 p-2">
                            <span class="block font-bold text-[10px] text-slate-500">FECHA NACIMIENTO</span>
                            <span class="block font-mono">{{ beca.fecha_nacimiento or '--' }}</span>
                        </div>
                        <div class="col-span-2 border-t border-r border-slate-400 p-2">
                            <span class="block font-bold text-[10px] text-slate-500">EDAD</span>
                            <span class="block font-semibold">{{ beca.edad }} Años</span>
                        </div>
                        <div class="col-span-2 border-t border-r border-slate-400 p-2">
                            <span class="block font-bold text-[10px] text-slate-500">SEXO</span>
                            <span class="block font-semibold uppercase">{{ beca.sexo }}</span>
                        </div>
                        <div class="col-span-2 border-t border-r border-slate-400 p-2">
                            <span class="block font-bold text-[10px] text-slate-500">SANGRE</span>
                            <span class="block font-semibold">{{ beca.sangre or '--' }}</span>
                        </div>
                        <div class="col-span-3 border-t border-r border-slate-400 p-2">
                            <span class="block font-bold text-[10px] text-slate-500">PESO / ESTATURA</span>
                            <span class="block font-semibold">{{ beca.peso }}kg / {{ beca.estatura }}m</span>
                        </div>
                    </div>

                    <!-- Columna Derecha (Foto) -->
                    <div
                        class="col-span-2 border-t border-r border-slate-400 p-1 relative flex items-center justify-center bg-slate-100">
                        {% if beca.foto %}
                        <img src="{{ beca.foto }}" alt="Foto"
                            class="w-full h-auto object-cover border border-slate-300">
                        {% else %}
                        <div class="text-center text-slate-400">
                            <i class="fa-solid fa-user text-4xl mb-2"></i>
                            <span class="block text-[10px]">SIN FOTO</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Dirección y Contacto -->
            <div class="mb-6">
                <h3 class="bg-slate-800 text-white font-bold px-2 py-1 text-xs uppercase mb-0">Ubicación y Contacto</h3>
                <div class="border border-slate-400 grid grid-cols-2">
                    <div class="p-2 border-r border-slate-400">
                        <span class="block font-bold text-[10px] text-slate-500">DIRECCIÓN</span>
                        <span class="block text-sm uppercase">{{ beca.direccion or '--' }}</span>
                        <div class="mt-2 text-xs">
                            <span class="font-bold">Municipio:</span> {{ beca.municipio }}
                        </div>
                    </div>
                    <div class="p-2">
                        <span class="block font-bold text-[10px] text-slate-500">CONTACTO</span>
                        <div class="text-sm">
                            <i class="fa-solid fa-phone text-slate-400 mr-1"></i> {{ beca.telefono or '--' }}
                        </div>
                        <div class="text-sm mt-1">
                            <i class="fa-solid fa-envelope text-slate-400 mr-1"></i> {{ beca.email or '--' }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Datos Deportivos y Tallas (Nueva Página) -->
            <div class="grid grid-cols-2 gap-6 mb-6 print-page-break">
                <!-- Tallas -->
                <div>
                    <h3 class="bg-slate-800 text-white font-bold px-2 py-1 text-xs uppercase mb-0">Tallas y Medidas</h3>
                    <div class="border border-slate-400 p-2 grid grid-cols-3 gap-2 text-center">
                        <div class="bg-slate-50 p-1 rounded">
                            <span class="block text-[10px] font-bold text-slate-500">ZAPATO</span>
                            <span class="font-bold">{{ beca.talla_zapato or '--' }}</span>
                        </div>
                        <div class="bg-slate-50 p-1 rounded">
                            <span class="block text-[10px] font-bold text-slate-500">FRANELA</span>
                            <span class="font-bold">{{ beca.talla_franela or '--' }}</span>
                        </div>
                        <div class="bg-slate-50 p-1 rounded">
                            <span class="block text-[10px] font-bold text-slate-500">SHORT</span>
                            <span class="font-bold">{{ beca.talla_short or '--' }}</span>
                        </div>
                        <div class="bg-slate-50 p-1 rounded">
                            <span class="block text-[10px] font-bold text-slate-500">MONO</span>
                            <span class="font-bold">{{ beca.talla_mono or '--' }}</span>
                        </div>
                        <div class="bg-slate-50 p-1 rounded">
                            <span class="block text-[10px] font-bold text-slate-500">CHEMISE</span>
                            <span class="font-bold">{{ beca.talla_chemise or '--' }}</span>
                        </div>
                        <div class="bg-slate-50 p-1 rounded">
                            <span class="block text-[10px] font-bold text-slate-500">COMPETENCIA</span>
                            <span class="font-bold">{{ beca.talla_competencia or '--' }}</span>
                        </div>
                    </div>
                </div>

                <!-- Información Médica -->
                <div>
                    <h3 class="bg-slate-800 text-white font-bold px-2 py-1 text-xs uppercase mb-0">Información Médica
                    </h3>
                    <div class="border border-slate-400 p-2 text-sm">
                        <div class="flex justify-between border-b border-slate-200 py-1">
                            <span>¿Usa Lentes?</span>
                            <span class="font-bold">{{ beca.usa_lentes }}</span>
                        </div>
                        <div class="flex justify-between border-b border-slate-200 py-1">
                            <span>¿Protector Bucal?</span>
                            <span class="font-bold">{{ beca.usa_bucal }}</span>
                        </div>
                        <div class="flex justify-between border-b border-slate-200 py-1">
                            <span>¿Rodilleras?</span>
                            <span class="font-bold">{{ beca.usa_rodilleras }}</span>
                        </div>
                        <div class="flex justify-between py-1">
                            <span>¿Control Médico?</span>
                            <span class="font-bold">{{ beca.control_medico }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medallas -->
            <div class="mb-6">
                <h3 class="bg-slate-800 text-white font-bold px-2 py-1 text-xs uppercase mb-0">Medallas y Logros</h3>
                <div class="border border-slate-400 p-4 min-h-[100px]">
                    {% if medallas %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        {% for medalla in medallas %}
                        <div class="flex items-center gap-3 p-2 border border-slate-200 rounded bg-slate-50">
                            {% if medalla.tipo_medalla == 'Oro' %}
                            <i class="fa-solid fa-medal text-yellow-500 text-xl"></i>
                            {% elif medalla.tipo_medalla == 'Plata' %}
                            <i class="fa-solid fa-medal text-slate-400 text-xl"></i>
                            {% else %}
                            <i class="fa-solid fa-medal text-orange-700 text-xl"></i>
                            {% endif %}
                            <div>
                                <span class="block font-bold text-sm">{{ medalla.competicion }}</span>
                                <span class="block text-xs text-slate-500">{{ medalla.tipo_medalla }} - {{ medalla.fecha
                                    }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-center text-slate-400 italic text-sm">No hay medallas registradas.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Documentos -->
            <div class="mb-8" id="documentos-section">
                <h3
                    class="bg-blue-800 text-white font-bold px-2 py-1 text-xs uppercase mb-0 flex justify-between items-center">
                    Documentos Digitales
                    {% if user_role in ['admin', 'superadmin'] %}
                    <span class="text-[10px] font-normal opacity-80">Subir archivos en "Editar Datos"</span>
                    {% endif %}
                </h3>

                <div class="border border-slate-400 p-4 bg-slate-50">
                    <!-- Lista de Documentos -->
                    {% if documentos %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 responsive-grid">
                        {% for doc in documentos %}
                        <div
                            class="flex justify-between items-center p-2 bg-white border border-slate-200 rounded shadow-sm">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <i class="fa-solid fa-file-pdf text-red-600"></i>
                                <span class="text-xs font-bold truncate uppercase">{{ doc.nombre }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <!-- BOTÓN VER (Modal) -->
                                <button onclick="verPDF('{{ doc.archivo }}')"
                                    class="text-blue-600 hover:text-blue-800 text-xs font-bold flex items-center gap-1">
                                    <i class="fa-solid fa-eye"></i> Ver
                                </button>

                                {% if user_role in ['admin', 'superadmin'] %}
                                <form action="{{ url_for('dashboard.eliminar_documento', doc_id=doc.id) }}"
                                    method="POST" onsubmit="return confirmarEliminar('documento', '{{ doc.nombre }}');">
                                    <input type="hidden" name="atleta_id" value="{{ beca.id }}">
                                    <button type="submit" class="text-slate-400 hover:text-red-600"><i
                                            class="fa-solid fa-trash"></i></button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-xs text-slate-400 italic text-center">No hay documentos digitales cargados.</p>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>

<!-- MODAL PREVISUALIZACIÓN PDF RESTAURADO -->
<div id="modalPDF"
    class="fixed inset-0 z-50 hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 no-print">
    <div class="bg-white w-full max-w-6xl h-[90vh] rounded-lg shadow-2xl flex flex-col overflow-hidden relative">
        <!-- Header Modal -->
        <div class="flex justify-between items-center p-4 bg-slate-900 text-white shrink-0">
            <h3 class="font-bold text-base flex items-center gap-2">
                <i class="fa-solid fa-file-pdf text-red-500"></i> Visualizador de Documento
            </h3>
            <div class="flex items-center gap-4">
                <a id="btnOpenNewTab" href="#" target="_blank"
                    class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded transition-colors">
                    <i class="fa-solid fa-external-link-alt mr-1"></i> Abrir en Nueva Pestaña
                </a>
                <button onclick="cerrarPDF()"
                    class="text-slate-400 hover:text-white transition-colors text-2xl leading-none">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Viewer Container -->
        <div id="pdfContainer" class="flex-1 w-full h-full bg-slate-100 overflow-hidden relative">
            <!-- El <object> se inyectará aquí via JS -->
            <div class="absolute inset-0 flex items-center justify-center text-slate-400">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl"></i>
            </div>
        </div>
    </div>
</div>

<script>
    // Funciones de impresión mantenidas

    // PDF MODAL FUNCTIONS
    function verPDF(url) {
        document.getElementById('modalPDF').classList.remove('hidden');
        var container = document.getElementById('pdfContainer');
        var btnNewTab = document.getElementById('btnOpenNewTab');

        // Actualizar botón de "Abrir en nueva pestaña"
        btnNewTab.href = url;

        // Usar OBJECT tag para mejor compatibilidad
        container.innerHTML = `
            <object data="${url}" type="application/pdf" class="w-full h-full rounded bg-slate-100">
                <div class="flex flex-col items-center justify-center h-full text-slate-500 gap-4">
                    <p>Tu navegador no puede visualizar este PDF aquí.</p>
                    <a href="${url}" target="_blank" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Abrir en Nueva Pestaña
                    </a>
                </div>
            </object>
        `;
    }

    function cerrarPDF() {
        document.getElementById('modalPDF').classList.add('hidden');
        document.getElementById('pdfContainer').innerHTML = ''; // Limpiar para detener carga
    }


    function imprimirFichaDocumentos() {
        // Agregar clase especial al body para activar estilos de impresión selectiva
        document.body.classList.add('print-only-ficha');

        // Imprimir
        window.print();

        // Remover la clase después de imprimir
        setTimeout(function () {
            document.body.classList.remove('print-only-ficha');
        }, 100);
    }
</script>

<style>
    /* Preserve intended text colors in this page */
    .text-slate-500 {
        color: #64748b !important;
    }

    .text-slate-600 {
        color: #475569 !important;
    }

    .text-slate-400 {
        color: #94a3b8 !important;
    }

    .text-blue-800 {
        color: #1e40af !important;
    }

    .text-blue-600 {
        color: #2563eb !important;
    }

    /* Force white text on dark backgrounds */
    .bg-slate-800,
    .bg-blue-800 {
        color: white !important;
    }

    .bg-slate-800 *,
    .bg-blue-800 * {
        color: white !important;
    }

    @media print {

        /* Ocultar elementos de navegación */
        .no-print,
        nav,
        header,
        footer,
        button:not(#ficha-tecnica button) {
            display: none !important;
        }

        /* Resetear estilos de página */
        body {
            background: white;
            margin: 0;
            padding: 0;
        }

        /* Contenedor principal */
        main {
            margin: 0 !important;
            padding: 0 !important;
            max-width: 100% !important;
        }

        /* Ficha técnica */
        #ficha-tecnica {
            box-shadow: none !important;
            border: 1px solid #000 !important;
            page-break-after: auto;
        }

        /* Ocultar sección de documentos digitales */
        #documentos-section {
            display: none !important;
        }

        /* Salto de página para Tallas y Médica */
        .print-page-break {
            page-break-before: always;
        }

        /* Impresión selectiva: solo ficha + documentos */
        body.print-only-ficha .no-print {
            display: none !important;
        }

        body.print-only-ficha #ficha-tecnica {
            display: block !important;
        }

        /* Ajustes de tamaño de página */
        @page {
            size: letter landscape;
            margin: 1cm;
        }
    }
</style>
{% endblock %}