{% extends "layout.html" %}

{% block title %}Atletas{% endblock %}
{% block header %}Listado de Atletas{% endblock %}

{% block content %}
<!-- Variables de permisos -->
{% set canEdit = user_role in ['admin', 'superadmin'] %}

<div class="space-y-6">

    <!-- Barra de Acciones y Filtros -->
    <div
        class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-slate-100">

        <!-- Buscador y Filtro -->
        <div class="flex flex-1 w-full md:w-auto gap-4 items-center overflow-hidden">
            <!-- Buscador Funcional -->
            <form method="GET" action="{{ url_for('dashboard.lista_becas') }}"
                class="relative w-full md:w-64 flex-shrink-0">
                {% if current_filter %}
                <input type="hidden" name="disciplina" value="{{ current_filter }}">
                {% endif %}
                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                    <svg class="h-5 w-5 text-slate-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a1 1 0 11-1.414 1.414l-3.329-3.328A7 7 0 012 9z"
                            clip-rule="evenodd" />
                    </svg>
                </div>
                <input type="text" name="buscar" value="{{ current_search or '' }}"
                    class="block w-full rounded-md border-0 py-1.5 pl-10 pr-10 text-slate-900 ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6"
                    placeholder="Buscar nombre...">
                {% if current_search %}
                <a href="{{ url_for('dashboard.lista_becas', disciplina=current_filter) }}"
                    class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 hover:text-slate-600">
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z"
                            clip-rule="evenodd" />
                    </svg>
                </a>
                {% endif %}
            </form>

            <!-- Filtro Visual de Disciplinas -->
            <div class="w-full overflow-x-auto pb-2">
                <div class="flex gap-3 min-w-max">
                    <a href="{{ url_for('dashboard.lista_becas') }}"
                        class="flex flex-col items-center justify-center w-24 h-24 rounded-xl border-2 transition-all duration-200 group
                       {{ 'border-blue-600 bg-blue-50 text-blue-700 shadow-md' if not current_filter or current_filter == 'Todas' else 'border-slate-200 bg-white text-slate-500 hover:border-blue-300 hover:shadow-sm' }}">
                        <i
                            class="fa-solid fa-layer-group text-2xl mb-2 {{ 'text-blue-600' if not current_filter or current_filter == 'Todas' else 'text-slate-400 group-hover:text-blue-500' }}"></i>
                        <span class="text-xs font-semibold text-center leading-tight"
                            style="color: {{ '#2563eb' if not current_filter or current_filter == 'Todas' else '#64748b' }} !important;">Todas</span>
                    </a>

                    {% for d in disciplinas %}
                    {% set icon_class = 'fa-person-running' %}
                    {% if 'Futbol' in d or 'F√∫tbol' in d %}{% set icon_class = 'fa-futbol' %}
                    {% elif 'Baloncesto' in d or 'Basket' in d %}{% set icon_class = 'fa-basketball' %}
                    {% elif 'Voleibol' in d or 'Voley' in d %}{% set icon_class = 'fa-volleyball' %}
                    {% elif 'Beisbol' in d or 'B√©isbol' in d %}{% set icon_class = 'fa-baseball-bat-ball' %}
                    {% elif 'Natacion' in d or 'Nataci√≥n' in d %}{% set icon_class = 'fa-person-swimming' %}
                    {% elif 'Atletismo' in d %}{% set icon_class = 'fa-person-running' %}
                    {% elif 'Karate' in d or 'Judo' in d or 'Taekwondo' in d %}{% set icon_class = 'fa-hand-fist' %}
                    {% elif 'Ajedrez' in d %}{% set icon_class = 'fa-chess' %}
                    {% elif 'Tenis' in d %}{% set icon_class = 'fa-table-tennis-paddle-ball' %}
                    {% elif 'Ciclismo' in d %}{% set icon_class = 'fa-bicycle' %}
                    {% elif 'Boxeo' in d %}{% set icon_class = 'fa-mitten' %}
                    {% elif 'Pesas' in d or 'Halterofilia' in d %}{% set icon_class = 'fa-dumbbell' %}
                    {% endif %}

                    <a href="{{ url_for('dashboard.lista_becas', disciplina=d) }}"
                        class="flex flex-col items-center justify-center w-24 h-24 rounded-xl border-2 transition-all duration-200 group
                           {{ 'border-blue-600 bg-blue-50 text-blue-700 shadow-md' if current_filter == d else 'border-slate-200 bg-white text-slate-500 hover:border-blue-300 hover:shadow-sm' }}">
                        <i
                            class="fa-solid {{ icon_class }} text-2xl mb-2 {{ 'text-blue-600' if current_filter == d else 'text-slate-400 group-hover:text-blue-500' }}"></i>
                        <span class="text-xs font-semibold text-center leading-tight px-1 truncate w-full"
                            style="color: {{ '#2563eb' if current_filter == d else '#64748b' }} !important;">{{ d
                            }}</span>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Bot√≥n Nuevo -->
        {% if canEdit %}
        <a href="{{ url_for('dashboard.crear_beca') }}"
            class="inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 transition-colors whitespace-nowrap flex-shrink-0">
            <svg class="-ml-0.5 mr-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 00-1.5 0v2.5h-2.5a.75.75 0 000 1.5h2.5v2.5a.75.75 0 001.5 0v-2.5h2.5a.75.75 0 000-1.5h-2.5v-2.5z"
                    clip-rule="evenodd" />
            </svg>
            Nuevo Atleta
        </a>
        {% endif %}
    </div>

    <!-- ============================================
         LAYOUT DE 3 COLUMNAS CON GALER√çA
         ============================================ -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- ========== COLUMNA IZQUIERDA - GALER√çA (20-25%) ========== -->
        <div class="hidden lg:block lg:col-span-2">
            <div class="sticky top-4 flex flex-col gap-4 gallery-parallax" data-speed="0.3">
                {% for i in range(1, 4) %}
                <div class="gallery-card group relative overflow-hidden rounded-2xl shadow-lg aspect-[3/4] bg-gradient-to-br from-slate-100 to-slate-200"
                    data-side="left" data-index="{{ i - 1 }}">
                    <!-- Imagen -->
                    <img src="{{ gallery_images.left[i - 1] if gallery_images.left and (i - 1) < gallery_images.left|length else url_for('static', filename='demos/placeholder-athlete-' ~ i ~ '.jpg') }}"
                        alt="Atleta destacado {{ i }}"
                        class="gallery-img w-full h-full object-cover transition-all duration-500 group-hover:scale-105"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <!-- Placeholder si no hay imagen -->
                    <div class="absolute inset-0 flex-col items-center justify-center text-slate-400 hidden">
                        <i class="fa-solid fa-image text-4xl mb-2"></i>
                        <span class="text-sm font-medium">Sin imagen</span>
                    </div>

                    <!-- Overlay de edici√≥n (Solo Admins) -->
                    {% if canEdit %}
                    <div class="gallery-overlay absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col items-center justify-center cursor-pointer"
                        onclick="triggerGalleryUpload('left_{{ (gallery_images.left|length) + 1 if gallery_images.left else i }}')">
                        <div
                            class="transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
                            <div
                                class="w-14 h-14 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center mb-3 mx-auto border-2 border-white/40">
                                <i class="fa-solid fa-camera text-white text-xl"></i>
                            </div>
                            <span class="text-white font-semibold text-sm">Cambiar Foto</span>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Badge inferior -->
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-3">
                        <span class="text-white text-xs font-semibold uppercase tracking-wider">Atleta Destacado</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- ========== COLUMNA CENTRAL - TABLA (50-60%) ========== -->
        <div class="lg:col-span-8">
            <div class="bg-white shadow-sm ring-1 ring-slate-900/5 rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    Nombre / Email</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    C√©dula</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    Disciplina</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    Estatus</th>
                                <th scope="col" class="relative px-6 py-3"><span class="sr-only">Acciones</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-200">
                            {% for beca in becas %}
                            <tr class="hover:bg-slate-50 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div
                                            class="h-10 w-10 flex-shrink-0 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold shadow-md">
                                            {{ beca.nombre[0] }}{{ beca.apellido[0] }}
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-slate-900">
                                                <a href="{{ url_for('dashboard.ver_beca', beca_id=beca.id) }}"
                                                    class="hover:text-blue-600 hover:underline transition-colors cursor-pointer"
                                                    title="Ver Ficha Completa">
                                                    {{ beca.nombre }} {{ beca.apellido }}
                                                </a>
                                            </div>
                                            <div class="text-sm text-slate-500">{{ beca.email }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">{{ beca.cedula }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">{{ beca.disciplina }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-semibold shadow-sm transition-colors
                                        {% if beca.estatus == 'Activo' %}bg-green-500 text-white
                                        {% elif beca.estatus == 'Inactivo' %}bg-red-500 text-white
                                        {% else %}bg-yellow-400 text-gray-900{% endif %}"
                                        style="{% if beca.estatus == 'Activo' %}background-color: #22c55e !important; color: white !important;
                                        {% elif beca.estatus == 'Inactivo' %}background-color: #ef4444 !important; color: white !important;
                                        {% else %}background-color: #fbbf24 !important; color: #111827 !important;{% endif %}">
                                        {{ beca.estatus }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <div class="flex justify-end gap-3 items-center">
                                        {% if canEdit %}
                                        <a href="{{ url_for('dashboard.editar_beca', beca_id=beca.id) }}"
                                            class="inline-flex items-center px-3 py-1.5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow-sm"
                                            style="background-color: #2563eb !important; color: white !important;">
                                            <i class="fa-solid fa-pen-to-square mr-1.5"></i>
                                            Editar
                                        </a>
                                        {% endif %}

                                        {% if user_role == 'superadmin' %}
                                        <form action="{{ url_for('dashboard.eliminar_beca', beca_id=beca.id) }}"
                                            method="POST" class="inline"
                                            onsubmit="return confirmarEliminar(event, 'atleta', '{{ beca.nombre }} {{ beca.apellido }}');">
                                            <button type="submit"
                                                class="inline-flex items-center px-3 py-1.5 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors shadow-sm"
                                                style="background-color: #dc2626 !important; color: white !important;">
                                                <i class="fa-solid fa-trash mr-1.5"></i>
                                                Borrar
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="px-6 py-12 text-center text-slate-500">
                                    <div class="flex flex-col items-center">
                                        <i class="fa-solid fa-users-slash text-4xl text-slate-300 mb-3"></i>
                                        <p class="text-base">No se encontraron atletas.</p>
                                        {% if current_filter and current_filter != 'Todas' %}
                                        <p class="text-sm mt-1">Intenta seleccionar "Todas las Disciplinas".</p>
                                        {% elif canEdit %}
                                        <p class="text-sm mt-1">Comienza agregando uno nuevo.</p>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Paginaci√≥n -->
                {% if total_pages > 1 %}
                <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6">
                    <div class="flex flex-1 justify-between sm:hidden">
                        {% if page > 1 %}
                        <a href="{{ url_for('dashboard.lista_becas', page=page-1, disciplina=current_filter, buscar=current_search) }}"
                            class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Anterior</a>
                        {% else %}
                        <span
                            class="relative inline-flex items-center rounded-md border border-gray-300 bg-gray-100 px-4 py-2 text-sm font-medium text-gray-400 cursor-not-allowed">Anterior</span>
                        {% endif %}

                        {% if page < total_pages %} <a
                            href="{{ url_for('dashboard.lista_becas', page=page+1, disciplina=current_filter, buscar=current_search) }}"
                            class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                            Siguiente</a>
                            {% else %}
                            <span
                                class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-gray-100 px-4 py-2 text-sm font-medium text-gray-400 cursor-not-allowed">Siguiente</span>
                            {% endif %}
                    </div>
                    <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Mostrando p√°gina <span class="font-medium">{{ page }}</span> de <span
                                    class="font-medium">{{ total_pages }}</span>
                                (<span class="font-medium">{{ total }}</span> resultados)
                            </p>
                        </div>
                        <div>
                            <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
                                {% if page > 1 %}
                                <a href="{{ url_for('dashboard.lista_becas', page=page-1, disciplina=current_filter, buscar=current_search) }}"
                                    class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                    <span class="sr-only">Anterior</span>
                                    <i class="fa-solid fa-chevron-left h-5 w-5 flex items-center justify-center"></i>
                                </a>
                                {% else %}
                                <span
                                    class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-300 ring-1 ring-inset ring-gray-300 cursor-not-allowed">
                                    <span class="sr-only">Anterior</span>
                                    <i class="fa-solid fa-chevron-left h-5 w-5 flex items-center justify-center"></i>
                                </span>
                                {% endif %}

                                {% for p in range(1, total_pages + 1) %}
                                {% if p == page %}
                                <span aria-current="page"
                                    class="relative z-10 inline-flex items-center bg-blue-600 px-4 py-2 text-sm font-semibold text-white focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600">{{
                                    p }}</span>
                                {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %} <a
                                    href="{{ url_for('dashboard.lista_becas', page=p, disciplina=current_filter, buscar=current_search) }}"
                                    class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                    {{ p }}</a>
                                    {% elif p == page - 3 or p == page + 3 %}
                                    <span
                                        class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-700 ring-1 ring-inset ring-gray-300 focus:outline-offset-0">...</span>
                                    {% endif %}
                                    {% endfor %}

                                    {% if page < total_pages %} <a
                                        href="{{ url_for('dashboard.lista_becas', page=page+1, disciplina=current_filter, buscar=current_search) }}"
                                        class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                        <span class="sr-only">Siguiente</span>
                                        <i
                                            class="fa-solid fa-chevron-right h-5 w-5 flex items-center justify-center"></i>
                                        </a>
                                        {% else %}
                                        <span
                                            class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-300 ring-1 ring-inset ring-gray-300 cursor-not-allowed">
                                            <span class="sr-only">Siguiente</span>
                                            <i
                                                class="fa-solid fa-chevron-right h-5 w-5 flex items-center justify-center"></i>
                                        </span>
                                        {% endif %}
                            </nav>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- ========== COLUMNA DERECHA - GALER√çA (20-25%) ========== -->
        <div class="hidden lg:block lg:col-span-2">
            <div class="sticky top-4 flex flex-col gap-4 gallery-parallax" data-speed="-0.3">
                {% for i in range(1, 4) %}
                <div class="gallery-card group relative overflow-hidden rounded-2xl shadow-lg aspect-[3/4] bg-gradient-to-br from-slate-100 to-slate-200"
                    data-side="right" data-index="{{ i - 1 }}">
                    <!-- Imagen -->
                    <img src="{{ gallery_images.right[i - 1] if gallery_images.right and (i - 1) < gallery_images.right|length else url_for('static', filename='demos/placeholder-athlete-' ~ (i + 3) ~ '.jpg') }}"
                        alt="Atleta destacado {{ i + 3 }}"
                        class="gallery-img w-full h-full object-cover transition-all duration-500 group-hover:scale-105"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <!-- Placeholder si no hay imagen -->
                    <div class="absolute inset-0 flex-col items-center justify-center text-slate-400 hidden">
                        <i class="fa-solid fa-image text-4xl mb-2"></i>
                        <span class="text-sm font-medium">Sin imagen</span>
                    </div>

                    <!-- Overlay de edici√≥n (Solo Admins) -->
                    {% if canEdit %}
                    <div class="gallery-overlay absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col items-center justify-center cursor-pointer"
                        onclick="triggerGalleryUpload('right_{{ (gallery_images.right|length) + 1 if gallery_images.right else i }}')">
                        <div
                            class="transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
                            <div
                                class="w-14 h-14 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center mb-3 mx-auto border-2 border-white/40">
                                <i class="fa-solid fa-camera text-white text-xl"></i>
                            </div>
                            <span class="text-white font-semibold text-sm">Cambiar Foto</span>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Badge inferior -->
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-3">
                        <span class="text-white text-xs font-semibold uppercase tracking-wider">Atleta Destacado</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

    </div><!-- Fin del grid 3 columnas -->

</div>

<!-- Input oculto para subida de im√°genes -->
<input type="file" id="galleryUploadInput" accept="image/*" class="hidden" onchange="handleGalleryUpload(this)">

<!-- Estilos adicionales -->
<style>
    /* Animaciones suaves para las tarjetas de galer√≠a */
    .gallery-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .gallery-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.25);
    }

    /* Transici√≥n suave para rotaci√≥n de im√°genes */
    .gallery-img {
        transition: opacity 0.5s ease-in-out, transform 0.5s ease;
    }

    /* Efecto glassmorphism en overlay */
    .gallery-overlay {
        backdrop-filter: blur(2px);
    }

    /* Responsive: mostrar galer√≠a en m√≥vil como carrusel horizontal */
    @media (max-width: 1023px) {
        .gallery-mobile-scroll {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            gap: 1rem;
            padding: 1rem 0;
        }

        .gallery-mobile-scroll .gallery-card {
            flex-shrink: 0;
            width: 45%;
            scroll-snap-align: start;
        }
    }
</style>

<!-- Script para manejo de subida de im√°genes y rotaci√≥n autom√°tica -->
<script>
    let currentGallerySlot = null;

    // ============================================
    // ROTACI√ìN AUTOM√ÅTICA DE GALER√çA
    // ============================================

    // Pool de im√°genes desde el servidor
    const galleryPool = {
        left: {{ gallery_images.left | tojson | safe }},
    right: { { gallery_images.right | tojson | safe } }
    };

    // √çndices actuales de rotaci√≥n para cada slot visible
    let currentIndices = {
        left: [0, 1, 2],
        right: [0, 1, 2]
    };

    /**
     * Rota las im√°genes de la galer√≠a
     */
    function rotateGallery() {
        ['left', 'right'].forEach(side => {
            const pool = galleryPool[side];

            // Solo rotar si hay m√°s de 3 im√°genes
            if (!pool || pool.length <= 3) return;

            const cards = document.querySelectorAll(`[data-side="${side}"]`);

            cards.forEach((card, slotIdx) => {
                // Avanzar al siguiente √≠ndice en el pool (circular)
                currentIndices[side][slotIdx] = (currentIndices[side][slotIdx] + 1) % pool.length;

                const img = card.querySelector('.gallery-img');
                const placeholder = img.nextElementSibling;
                const nextImage = pool[currentIndices[side][slotIdx]];

                if (!nextImage) return;

                // Animaci√≥n fade out
                img.style.opacity = '0';

                // Cambiar imagen despu√©s del fade out
                setTimeout(() => {
                    img.src = nextImage;
                    img.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';

                    // Animaci√≥n fade in
                    setTimeout(() => {
                        img.style.opacity = '1';
                    }, 50);
                }, 500); // Tiempo del fade out
            });
        });
    }

    /**
     * Inicializa la galer√≠a con las primeras im√°genes
     */
    function initGallery() {
        ['left', 'right'].forEach(side => {
            const pool = galleryPool[side];
            if (!pool || pool.length === 0) return;

            const cards = document.querySelectorAll(`[data-side="${side}"]`);

            cards.forEach((card, idx) => {
                const img = card.querySelector('.gallery-img');
                const placeholder = img.nextElementSibling;

                if (pool[idx]) {
                    img.src = pool[idx];
                    img.style.display = 'block';
                    img.style.opacity = '1';
                    if (placeholder) placeholder.style.display = 'none';
                } else {
                    // No hay suficientes im√°genes para este slot
                    img.style.display = 'none';
                    if (placeholder) placeholder.style.display = 'flex';
                }
            });
        });

        // Log para debugging
        console.log('üñºÔ∏è Galer√≠a inicializada:', {
            left: `${galleryPool.left?.length || 0} im√°genes`,
            right: `${galleryPool.right?.length || 0} im√°genes`,
            rotationEnabled: (galleryPool.left?.length > 3 || galleryPool.right?.length > 3)
        });
    }

    // ============================================
    // SUBIDA DE IM√ÅGENES
    // ============================================

    function triggerGalleryUpload(slot) {
        currentGallerySlot = slot;
        document.getElementById('galleryUploadInput').click();
    }

    async function handleGalleryUpload(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];
        const formData = new FormData();
        formData.append('image', file);
        formData.append('slot', currentGallerySlot);

        try {
            // Mostrar preview inmediato
            const reader = new FileReader();
            reader.onload = function (e) {
                // Determinar qu√© lado y slot
                const slotParts = currentGallerySlot.split('_');
                const side = slotParts[0]; // 'left' o 'right'
                const slotNumber = parseInt(slotParts[1]); // n√∫mero de slot

                // Agregar al pool si es un slot nuevo
                if (!galleryPool[side]) galleryPool[side] = [];
                if (slotNumber > galleryPool[side].length) {
                    galleryPool[side].push(e.target.result);
                } else {
                    galleryPool[side][slotNumber - 1] = e.target.result;
                }

                // Actualizar vista inmediatamente
                initGallery();
            };
            reader.readAsDataURL(file);

            // Enviar al servidor
            const response = await fetch('/dashboard/gallery/upload', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                if (typeof showSaveToast === 'function') {
                    showSaveToast('Imagen actualizada correctamente');
                } else {
                    console.log('‚úÖ Imagen actualizada correctamente');
                }
            } else {
                console.error('Error al subir imagen');
                if (typeof errorAlert === 'function') {
                    errorAlert('Error al subir la imagen. Int√©ntalo de nuevo.');
                }
            }
        } catch (error) {
            console.error('Error:', error);
        }

        // Limpiar input
        input.value = '';
    }

    // ============================================
    // INICIALIZACI√ìN
    // ============================================

    document.addEventListener('DOMContentLoaded', () => {
        // Inicializar galer√≠a
        initGallery();

        // Iniciar rotaci√≥n autom√°tica cada 60 segundos (1 minuto)
        const hasEnoughImagesForRotation =
            (galleryPool.left && galleryPool.left.length > 3) ||
            (galleryPool.right && galleryPool.right.length > 3);

        if (hasEnoughImagesForRotation) {
            setInterval(rotateGallery, 60000); // 60,000 ms = 1 minuto
            console.log('üîÑ Rotaci√≥n autom√°tica activada (cada 1 minuto)');
        } else {
            console.log('‚ÑπÔ∏è Rotaci√≥n desactivada (6 o menos im√°genes totales)');
        }
    });

</script>
{% endblock %}