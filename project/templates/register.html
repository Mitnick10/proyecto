{% extends "base.html" %}

{% block title %}Registro{% endblock %}

{% block content %}
<div class="relative min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="absolute inset-0 z-0"
        style="background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi7JWoDhdscUjLrQN6iqKerme1yy7-msHf1uB1NiILqNYlOkWZr5Cd8P2SfQI85bqMWO4CdanMOoB5WsvlGWVZLz2TsGzaGe8gdHM7g7LPxk93u9gJsxYZq81WddJXWv_M8gNMU8CUZLLg/s1600/65591412.wPaGxmkS.P7267968970'); background-size: cover; background-position: center; background-attachment: fixed;">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
    </div>

    <div class="relative z-10 w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden">

        <div class="p-8">
            <div class="flex flex-col items-center mb-8">
                <img class="h-24 w-auto drop-shadow-md mb-4" src="{{ url_for('static', filename='logo.png') }}"
                    alt="IRDEBG GUÁRICO">

                <h2 class="text-3xl font-extrabold text-gray-900 tracking-tight">Crear una cuenta</h2>
                <p class="mt-2 text-sm text-gray-600">
                    ¿Ya tienes cuenta?
                    <a href="{{ url_for('auth.login') }}"
                        class="font-medium text-blue-600 hover:text-blue-500 transition-colors">
                        Inicia sesión aquí
                    </a>
                </p>
            </div>

            <form class="space-y-6" action="{{ url_for('auth.register') }}" method="POST" id="registerForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}" />

                <!-- Sección: Datos Personales -->
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fa-solid fa-user text-blue-500 mr-2"></i> Datos Personales
                    </h3>
                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                            <input id="nombre" name="nombre" type="text" autocomplete="given-name" required
                                class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-shadow"
                                placeholder="Tu nombre">
                        </div>

                        <div>
                            <label for="apellido" class="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
                            <input id="apellido" name="apellido" type="text" autocomplete="family-name" required
                                class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-shadow"
                                placeholder="Tu apellido">
                        </div>

                        <div>
                            <label for="cedula" class="block text-sm font-medium text-gray-700 mb-1">Cédula de
                                Identidad</label>
                            <input id="cedula" name="cedula" type="text" required pattern="V-[0-9]{6,9}"
                                class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-shadow"
                                placeholder="Ej: V-12345678">
                        </div>
                    </div>
                </div>

                <!-- Sección: Cuenta y Seguridad -->
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fa-solid fa-shield-halved text-blue-500 mr-2"></i> Cuenta y Seguridad
                    </h3>

                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo
                                Electrónico</label>
                            <input id="email" name="email" type="email" autocomplete="email" required
                                class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-shadow"
                                placeholder="correo@ejemplo.com">
                        </div>

                        <div class="grid grid-cols-1 gap-6">
                            <div>
                                <label for="password"
                                    class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                                <input id="password" name="password" type="password" autocomplete="new-password"
                                    required minlength="6"
                                    class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-shadow"
                                    placeholder="Crear contraseña">
                            </div>

                            <div>
                                <label for="confirm_password"
                                    class="block text-sm font-medium text-gray-700 mb-1">Confirmar Contraseña</label>
                                <input id="confirm_password" name="confirm_password" type="password"
                                    autocomplete="new-password" required minlength="6"
                                    class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-shadow"
                                    placeholder="Repetir contraseña">
                            </div>
                        </div>

                        <!-- Indicadores de Contraseña -->
                        <div class="grid grid-cols-1 gap-6">
                            <!-- NUEVO: Indicador de fortaleza de contraseña -->
                            <div id="strengthIndicator" class="hidden bg-white p-3 rounded-md border border-gray-200">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs text-gray-500 font-medium">Fortaleza</span>
                                    <span id="strengthText" class="text-xs font-bold"></span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-1.5 mb-3">
                                    <div id="strengthBar" class="h-1.5 rounded-full transition-all duration-300"
                                        style="width: 0%"></div>
                                </div>
                                <div class="space-y-1">
                                    <div id="check-length" class="flex items-center text-xs text-gray-400">
                                        <i class="fa-solid fa-circle text-[6px] mr-2"></i> 6+ caracteres
                                    </div>
                                    <div id="check-lower" class="flex items-center text-xs text-gray-400">
                                        <i class="fa-solid fa-circle text-[6px] mr-2"></i> Minúscula
                                    </div>
                                    <div id="check-upper" class="flex items-center text-xs text-gray-400">
                                        <i class="fa-solid fa-circle text-[6px] mr-2"></i> Mayúscula
                                    </div>
                                    <div id="check-number" class="flex items-center text-xs text-gray-400">
                                        <i class="fa-solid fa-circle text-[6px] mr-2"></i> Número
                                    </div>
                                </div>
                            </div>

                            <!-- Indicador de Coincidencia -->
                            <div id="matchIndicator"
                                class="hidden flex items-center justify-center bg-white p-3 rounded-md border border-gray-200">
                                <span id="matchText" class="text-sm"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <button type="submit" id="submitBtn"
                        class="w-full flex justify-center py-3.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all uppercase tracking-wide">
                        REGISTRARSE
                    </button>
                    <p class="mt-4 text-center text-xs text-gray-500">
                        Al registrarte aceptas nuestros <a href="#" class="text-blue-600 hover:underline">Términos y
                            Condiciones</a>
                    </p>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript para validación en tiempo real -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirm_password');
        const strengthIndicator = document.getElementById('strengthIndicator');
        const strengthBar = document.getElementById('strengthBar');
        const strengthText = document.getElementById('strengthText');
        const matchIndicator = document.getElementById('matchIndicator');
        const matchText = document.getElementById('matchText');
        const submitBtn = document.getElementById('submitBtn');

        // Checks de requisitos
        const checks = {
            length: document.getElementById('check-length'),
            lower: document.getElementById('check-lower'),
            upper: document.getElementById('check-upper'),
            number: document.getElementById('check-number')
        };

        // Función para calcular fortaleza de contraseña
        function checkPasswordStrength(pwd) {
            let score = 0;
            const requirements = {
                length: pwd.length >= 6,
                lower: /[a-z]/.test(pwd),
                upper: /[A-Z]/.test(pwd),
                number: /\d/.test(pwd),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(pwd)
            };

            // Calcular puntos
            if (requirements.length) score += 20;
            if (pwd.length >= 8) score += 10;
            if (pwd.length >= 12) score += 10;
            if (requirements.lower) score += 15;
            if (requirements.upper) score += 15;
            if (requirements.number) score += 15;
            if (requirements.special) score += 15;

            return { score: Math.min(score, 100), requirements };
        }

        // Función para actualizar UI de checks
        function updateChecks(requirements) {
            Object.keys(checks).forEach(key => {
                const isValid = requirements[key];
                const checkEl = checks[key];
                const icon = checkEl.querySelector('i');

                if (isValid) {
                    checkEl.classList.remove('text-gray-400');
                    checkEl.classList.add('text-green-600', 'font-semibold');
                    icon.classList.remove('fa-circle');
                    icon.classList.add('fa-check');
                } else {
                    checkEl.classList.remove('text-green-600', 'font-semibold');
                    checkEl.classList.add('text-gray-400');
                    icon.classList.remove('fa-check');
                    icon.classList.add('fa-circle');
                }
            });
        }

        // Evento: al escribir en contraseña
        password.addEventListener('input', function () {
            const pwd = this.value;

            if (pwd.length > 0) {
                strengthIndicator.classList.remove('hidden');
                const { score, requirements } = checkPasswordStrength(pwd);

                // Actualizar barra de progreso
                strengthBar.style.width = score + '%';

                // Actualizar color y texto
                let color, text;
                if (score < 30) {
                    color = '#ef4444'; // red
                    text = 'Débil';
                } else if (score < 60) {
                    color = '#eab308'; // yellow
                    text = 'Media';
                } else {
                    color = '#22c55e'; // green
                    text = 'Fuerte';
                }

                strengthBar.style.backgroundColor = color;
                strengthText.textContent = text;
                strengthText.style.color = color;

                // Actualizar checks
                updateChecks(requirements);
            } else {
                strengthIndicator.classList.add('hidden');
            }

            // Verificar coincidencia si ya hay texto en confirm
            if (confirmPassword.value.length > 0) {
                checkPasswordMatch();
            }
        });

        // Función para verificar coincidencia
        function checkPasswordMatch() {
            const pwd = password.value;
            const confirm = confirmPassword.value;

            if (confirm.length > 0) {
                matchIndicator.classList.remove('hidden');

                if (pwd === confirm) {
                    matchText.innerHTML = '<i class="fa-solid fa-check text-green-500 mr-2"></i> Coinciden';
                    matchText.className = 'text-green-600 font-bold';
                    submitBtn.disabled = false;
                } else {
                    matchText.innerHTML = '<i class="fa-solid fa-xmark text-red-500 mr-2"></i> No coinciden';
                    matchText.className = 'text-red-500 font-medium';
                    submitBtn.disabled = true;
                }
            } else {
                matchIndicator.classList.add('hidden');
                submitBtn.disabled = false;
            }
        }

        // Evento: al escribir en confirmar contraseña
        confirmPassword.addEventListener('input', checkPasswordMatch);

        // Validación final antes de enviar
        document.getElementById('registerForm').addEventListener('submit', function (e) {
            const pwd = password.value;
            const confirm = confirmPassword.value;

            if (pwd !== confirm) {
                e.preventDefault();
                alert('Las contraseñas no coinciden');
                return false;
            }

            const { score, requirements } = checkPasswordStrength(pwd);
            const allRequired = requirements.length && requirements.lower &&
                requirements.upper && requirements.number;

            if (!allRequired) {
                e.preventDefault();
                alert('La contraseña no cumple con todos los requisitos de seguridad');
                return false;
            }
        });
    });
</script>
{% endblock %}